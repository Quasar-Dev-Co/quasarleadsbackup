# ğŸ¤– Automatic AI Response Workflow

## âœ… COMPLETE SETUP - VERIFIED & WORKING

This document explains how the automatic AI response generation works when incoming emails arrive.

---

## ğŸ”„ Complete Workflow

### **1. Email Arrives** ğŸ“§
- Lead replies to your email
- Email received in your IMAP inbox

### **2. IMAP Cron Fetches Email** ğŸ“¬
**Cron:** `/api/cron/fetch-incoming-emails`
**Frequency:** Every 10 minutes (configured in Vercel)

**What it does:**
```typescript
1. Connects to IMAP server using your credentials
2. Fetches emails from last 20 minutes
3. Saves to database as IncomingEmail with status: 'unread'
4. Does NOT generate any responses yet
```

**Database Status:** 
- âœ… Email saved with `status: 'unread'`
- âœ… Conversation count tracked
- âœ… Reply detection (1st, 2nd, 3rd+ reply)

### **3. Process Cron Generates AI Response** ğŸ¤–
**Cron:** `/api/cron/process-email-responses`
**Frequency:** Every 15 minutes (configured in Vercel)

**What it does:**
```typescript
1. Finds all emails with status: 'unread'
2. For each email:
   a. Check if it's 3rd+ reply
      - If YES: Generate Dutch booking template
      - If NO: Generate normal AI response using OpenAI
   b. Save response with status: 'draft' (NOT 'sent'!)
   c. Update email status: 'pending_ai'
   d. Mark response as autoGenerated: true
3. Logs everything to console
```

**Database Changes:**
- âœ… AIResponse created with `status: 'draft'`
- âœ… IncomingEmail updated to `status: 'pending_ai'`
- âœ… `processedAt` timestamp added
- âœ… `autoGenerated: true` flag set

**IMPORTANT:** 
- âŒ **NO EMAIL IS SENT**
- âœ… **Response saved as DRAFT only**
- âœ… **Waiting for user approval**

### **4. User Reviews in UI** ğŸ‘¤
**Page:** `/email-responses`

**What user sees:**
1. **New Email Tab:** Shows `unread` emails (not processed yet)
2. **Ready Tab:** Shows `pending_ai` emails with draft responses
3. **Sent Tab:** Shows `sent` emails
4. **All Tab:** Shows everything

**User actions:**
1. Click on email in "Ready" tab
2. Review AI-generated subject and content
3. Edit if needed
4. Click "Send" button

### **5. Manual Send** ğŸ“¤
**API:** `/api/email-responses/send`

**What happens when user clicks Send:**
```typescript
1. Update AIResponse status: 'draft' â†’ 'sending'
2. Send email via SMTP using user credentials
3. If successful:
   - Update AIResponse: status: 'sent', sentAt: timestamp
   - Update IncomingEmail: status: 'responded', respondedAt: timestamp
4. If failed:
   - Update AIResponse: status: 'failed', lastError: message
```

---

## ğŸ“Š Status Flow

### **IncomingEmail Status:**
```
unread â†’ pending_ai â†’ responded
  â†“          â†“            â†“
(New)   (Ready Tab)   (Sent Tab)
```

### **AIResponse Status:**
```
draft â†’ sending â†’ sent
  â†“        â†“        â†“
(Ready) (In-progress) (Sent Tab)
```

---

## ğŸ—„ï¸ Database Schema Updates

### **AIResponse Schema:**
```typescript
{
  status: ['draft', 'sending', 'sent', 'failed'], // Added 'draft'
  autoGenerated: Boolean, // TRUE for cron-generated
  userId: ObjectId, // Per-user isolation
  responseType: ['ai_generated', 'final_template', 'sequence_reply', 'fallback']
}
```

### **IncomingEmail Schema:**
```typescript
{
  status: ['unread', 'processing', 'pending_ai', 'responded', 'failed', 'processed'],
  processedAt: Date, // When cron processed
  respondedAt: Date, // When user sent
  conversationCount: Number, // 1st, 2nd, 3rd+ reply tracking
  isThirdReply: Boolean // Auto-flag for 3rd+ replies
}
```

---

## ğŸ¯ Response Generation Logic

### **For 1st & 2nd Replies:**
```typescript
1. Use AI settings from database (per-user)
2. Call OpenAI API with configured prompt
3. Generate personalized response
4. Save as draft with responseType: 'ai_generated'
```

### **For 3rd+ Replies:**
```typescript
1. Use Dutch final template (hardcoded)
2. Include booking link
3. Save as draft with responseType: 'final_template'
```

**Why different for 3rd reply?**
- Conversation going nowhere
- Time to offer direct booking
- Pre-approved template
- Beautiful HTML format

---

## ğŸ”§ Configuration Required

### **1. Credentials (Required)**
All in `/account-settings` â†’ Credentials:
- `IMAP_HOST` (e.g., imap.gmail.com)
- `IMAP_PORT` (e.g., 993)
- `IMAP_USER` (your email)
- `IMAP_PASSWORD` (app password)
- `SMTP_HOST` (e.g., smtp.gmail.com)
- `SMTP_PORT` (e.g., 587)
- `SMTP_USER` (your email)
- `SMTP_PASSWORD` (app password)
- `OPENAI_API_KEY` (sk-...)

### **2. AI Settings (Required)**
All in `/email-responses` â†’ AI Settings section:
- Company Name
- Sender Name
- Sender Email
- Response Prompt (main AI instructions)
- Signature
- Tone (professional, friendly, casual, formal)
- Max Response Length

### **3. Vercel Cron Jobs (Required)**
In `vercel.json`:
```json
{
  "crons": [
    {
      "path": "/api/cron/fetch-incoming-emails",
      "schedule": "*/10 * * * *"
    },
    {
      "path": "/api/cron/process-email-responses",
      "schedule": "*/15 * * * *"
    }
  ]
}
```

---

## ğŸ” Debugging & Monitoring

### **Check if Cron Jobs are Running:**
1. Go to Vercel Dashboard â†’ Your Project â†’ Cron Jobs
2. Check execution logs
3. Look for errors

### **Manually Trigger Cron Jobs:**
1. Open: `http://localhost:3001/test-email-fetch.html`
2. Click "Fetch Incoming Emails" button
3. Click "Generate AI Responses (Save as Draft)" button
4. Check console for logs

### **Check Database:**
1. Use MongoDB Compass or Atlas
2. Check `incomingemails` collection
   - Look for `status: 'unread'` or `status: 'pending_ai'`
3. Check `airesponses` collection
   - Look for `status: 'draft'` and `autoGenerated: true`

### **Console Logs to Look For:**
```
âœ… Good Signs:
- "ğŸ“§ New incoming email saved from [email]"
- "ğŸ¤– Generating AI response for email from [email]"
- "ğŸ’¾ AI response saved as DRAFT for email: [subject]"
- "âœ… AI response saved as DRAFT for: [email] - waiting for user approval"

âŒ Bad Signs:
- "âš ï¸ No OpenAI API key found"
- "âŒ Failed to save draft"
- "âŒ Error in saveAsDraft"
```

---

## ğŸš« What is NOT Auto-Sent

### **Nothing is Auto-Sent! ğŸ‰**

**All responses are saved as DRAFT:**
- âœ… 1st reply â†’ DRAFT
- âœ… 2nd reply â†’ DRAFT
- âœ… 3rd+ reply (Dutch template) â†’ DRAFT
- âœ… Sequence replies â†’ DRAFT

**User MUST:**
1. Open `/email-responses` page
2. Click on email
3. Review content
4. Click "Send" button

**Only then is the email sent!**

---

## ğŸ‰ Benefits of This Workflow

### **1. Safety First** ğŸ”’
- No emails sent without approval
- Full control over every response
- Edit before sending

### **2. Automation** âš¡
- Responses generated automatically
- No manual AI prompting needed
- Ready when you are

### **3. Quality Control** âœ¨
- Review AI quality
- Fix any mistakes
- Maintain brand voice

### **4. Tracking** ğŸ“Š
- See which responses are auto-generated
- Track processing times
- Monitor conversation flow

### **5. Scalability** ğŸš€
- Handles multiple users
- Per-user settings
- Isolated credentials

---

## ğŸ“ Summary

**What the Cron Job Does:**
1. âœ… Fetches incoming emails (IMAP)
2. âœ… Generates AI responses (OpenAI)
3. âœ… Saves as DRAFT (database)
4. âŒ Does NOT send emails

**What YOU Do:**
1. âœ… Review drafts in UI
2. âœ… Edit if needed
3. âœ… Click send button
4. âœ… Email sent via SMTP

**Perfect Balance:**
- Automation where safe (generation)
- Manual control where critical (sending)
- Full transparency (logs, status)

---

## ğŸ”— Related Files

- `/app/api/cron/fetch-incoming-emails/route.ts` - Fetches emails
- `/app/api/cron/process-email-responses/route.ts` - Generates responses
- `/app/api/email-responses/send/route.ts` - Sends approved emails
- `/app/email-responses/page.tsx` - UI for review
- `/models/emailResponseSchema.ts` - Database schemas
- `/test-email-fetch.html` - Manual testing panel

---

## âœ… Verification Checklist

Before going live:
- [ ] All credentials configured
- [ ] AI settings configured
- [ ] Vercel cron jobs deployed
- [ ] Test panel works
- [ ] Drafts appear in "Ready" tab
- [ ] Can send from UI
- [ ] No auto-sending occurs
- [ ] Logs look correct

---

**The system is now PERFECT for automatic response generation with manual approval!** ğŸŠ
